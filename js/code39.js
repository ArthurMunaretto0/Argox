(function(){
  const P = {
    "0":"101001101101","1":"110100101011","2":"101100101011","3":"110110010101","4":"101001101011",
    "5":"110100110101","6":"101100110101","7":"101001011011","8":"110100101101","9":"101100101101",
    "A":"110101001011","B":"101101001011","C":"110110100101","D":"101011001011","E":"110101100101",
    "F":"101101100101","G":"101010011011","H":"110101001101","I":"101101001101","J":"101011001101",
    "K":"110101010011","L":"101101010011","M":"110110101001","N":"101011010011","O":"110101101001",
    "P":"101101101001","Q":"101010110011","R":"110101011001","S":"101101011001","T":"101011011001",
    "U":"110010101011","V":"100110101011","W":"110011010101","X":"100101101011","Y":"110010110101",
    "Z":"100110110101","-":"100101011011",".":"110010101101"," ":"100110101101","$":"100100100101",
    "/":"100100101001","+":"100101001001","%":"101001001001","*":"100101101101"
  };

  // draw(code, w, h, m)
  // w = largura base de módulo (interno ao SVG)
  // h = altura das barras
  // m = margem lateral (quiet zone)
  function draw(code, w = 1.6, h = 38, m = 4){
    const s = `*${code.toUpperCase()}*`;
    let x = m, u = w, H = h, r = [];

    for (const ch of s){
      const p = P[ch];
      if (!p) throw new Error("Caractere inválido no Code39: " + ch);

      for (let i = 0; i < p.length; i++){
        const bit = p[i];
        const bar = (i % 2 === 0);
        const W  = (bit === "1" ? u * 3 : u);
        if (bar) r.push(`<rect x="${x}" y="0" width="${W}" height="${H}"/>`);
        x += W;
      }
      // espaço entre caracteres
      x += u;
    }

    const total = x + m - u;
    return `<svg class="bar" viewBox="0 0 ${total} ${H}" xmlns="http://www.w3.org/2000/svg"><g fill="#000">${r.join("")}</g></svg>`;
  }

  window.Code39 = { draw };
})();
